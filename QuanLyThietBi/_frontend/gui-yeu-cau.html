<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>G·ª≠i y√™u c·∫ßu m∆∞·ª£n thi·∫øt b·ªã</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 40px 20px;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(270deg, #a1c4fd, #c2e9fb, #fbc2eb, #a6c1ee);
      background-size: 1000% 1000%;
      animation: sparkle 15s ease infinite;
      color: #333;
    }
    @keyframes sparkle {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    h1 {
      text-align: center;
      color: #fff;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      padding: 20px;
      border-radius: 12px;
      text-transform: uppercase;
    }
    form {
      max-width: 800px;
      margin: 30px auto;
      background: #ffffffee;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    select, input[type="text"], input[type="range"], textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }
    input[type="range"] {
      accent-color: #007bff;
    }
    output {
      font-weight: bold;
      margin-left: 10px;
    }
    textarea {
      resize: vertical;
    }
    .checkbox {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .checkbox input {
      margin-right: 10px;
    }
    button {
      padding: 14px 24px;
      font-size: 16px;
      background: linear-gradient(to right, #ff758c, #ff7eb3);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 15px;
    }
    button:hover {
      transform: scale(1.05);
    }
    .back-btn {
      background: #6c757d;
    }
    .back-btn:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <h1>G·ª≠i y√™u c·∫ßu m∆∞·ª£n thi·∫øt b·ªã</h1>
  <form id="borrowForm">
    <label for="deviceSelect">Ch·ªçn thi·∫øt b·ªã c·∫ßn m∆∞·ª£n:</label>
    <select id="deviceSelect" required>
      <option value="">-- Vui l√≤ng ch·ªçn thi·∫øt b·ªã --</option>
    </select>

    <label for="borrowDate">Ng√†y m∆∞·ª£n (t·ªëi ƒëa 30 ng√†y): <output id="borrowDaysOutput">1</output> ng√†y</label>
    <input type="range" id="borrowDate" min="1" max="30" value="1" oninput="borrowDaysOutput.value = this.value">

    <label for="borrowerName">Ng∆∞·ªùi m∆∞·ª£n:</label>
    <input type="text" id="borrowerName" required placeholder="Nh·∫≠p h·ªç t√™n ng∆∞·ªùi m∆∞·ª£n">

    <label for="reason">L√Ω do m∆∞·ª£n:</label>
    <textarea id="reason" rows="4" required placeholder="Nh·∫≠p l√Ω do m∆∞·ª£n thi·∫øt b·ªã..."></textarea>

    <label for="signature">K√Ω t√™n:</label>
    <input type="text" id="signature" required placeholder="Nh·∫≠p t√™n k√Ω x√°c nh·∫≠n">

    <div class="checkbox">
      <input type="checkbox" id="confirm" required>
      <label for="confirm">X√°c nh·∫≠n ho√†n t·∫•t qu√° tr√¨nh m∆∞·ª£n thi·∫øt b·ªã</label>
    </div>

    <button type="submit">üì© G·ª≠i y√™u c·∫ßu</button>
    <button type="button" class="back-btn" onclick="goBack()">‚¨ÖÔ∏è Quay l·∫°i</button>
  </form>

  <script>
    async function loadAvailableDevices() {
      try {
        const res = await fetch('http://localhost:2704/api/devices');
        const data = await res.json();

        if (!data.success || !Array.isArray(data.data)) {
          throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");
        }

        const deviceSelect = document.getElementById('deviceSelect');
        let hasDevice = false;

        data.data.forEach(device => {
          // Hi·ªÉn th·ªã t·∫•t c·∫£ thi·∫øt b·ªã KH√îNG ph·∫£i "ƒêang m∆∞·ª£n"
          if (!device.status || device.status.toLowerCase() !== 'ƒëang m∆∞·ª£n') {
            const option = document.createElement('option');
            option.value = device.id;
            option.textContent = `${device.name} (${device.type}) - ${device.status}`;
            deviceSelect.appendChild(option);
            hasDevice = true;
          }
        });

        if (!hasDevice) {
          const option = document.createElement('option');
          option.textContent = "Kh√¥ng c√≥ thi·∫øt b·ªã kh·∫£ d·ª•ng";
          option.disabled = true;
          deviceSelect.appendChild(option);
        }

      } catch (err) {
        alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch thi·∫øt b·ªã!");
        console.error(err);
      }
    }

    document.getElementById('borrowForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const deviceId = document.getElementById('deviceSelect').value;
      const days = document.getElementById('borrowDate').value;
      const borrowerName = document.getElementById('borrowerName').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const signature = document.getElementById('signature').value.trim();
      const confirmed = document.getElementById('confirm').checked;

      if (!deviceId || !borrowerName || !reason || !signature || !confirmed) {
        alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† x√°c nh·∫≠n tr∆∞·ªõc khi g·ª≠i.");
        return;
      }

      try {
        const res = await fetch('http://localhost:2704/api/borrow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            deviceId,
            borrowerName,
            days: parseInt(days),
            reason,
            signature
          })
        });

        const result = await res.json();
        if (result.success) {
          alert("‚úÖ G·ª≠i ƒë∆°n m∆∞·ª£n thi·∫øt b·ªã th√†nh c√¥ng!");
          document.getElementById('borrowForm').reset();
          document.getElementById('borrowDaysOutput').value = 1;
        } else {
          alert("‚ùå G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i: " + result.message);
        }
      } catch (err) {
        alert("‚ùå Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i.");
        console.error(err);
      }
    });

    function goBack() {
      window.location.href = "dashboard.html";
    }

    loadAvailableDevices();
  </script>
</body>
</html>
