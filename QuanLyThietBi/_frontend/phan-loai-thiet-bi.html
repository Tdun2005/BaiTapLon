<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ph√¢n lo·∫°i thi·∫øt b·ªã</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 40px 20px;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(270deg, #a1c4fd, #c2e9fb, #fbc2eb, #a6c1ee);
      background-size: 1000% 1000%;
      animation: sparkle 15s ease infinite;
      color: #333;
      min-height: 100vh;
    }

    @keyframes sparkle {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 35px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    h2 {
      text-align: center;
      font-size: 34px;
      font-weight: bold;
      margin-top: 0;
      margin-bottom: 30px;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    h3 {
      text-align: center;
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 20px;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 17px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-weight: bold;
    }

    ul {
      font-size: 18px;
      padding-left: 20px;
    }

    li {
      margin: 6px 0;
      font-weight: bold;
    }

    button {
      padding: 14px 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      margin: 10px 10px 0 0;
      cursor: pointer;
    }

    .update-btn {
      background: linear-gradient(to right, #17a2b8, #00c6ff);
      color: white;
    }

    .finish-btn {
      background: linear-gradient(to right, #28a745, #218838);
      color: white;
    }

    .back-btn {
      background: #6c757d;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ph√¢n lo·∫°i thi·∫øt b·ªã</h2>

    <h3>Danh s√°ch thi·∫øt b·ªã</h3>
    <table id="deviceTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>T√™n</th>
          <th>Lo·∫°i</th>
          <th>T√¨nh tr·∫°ng</th>
          <th>Ng√†y th√™m</th>
          <th>Ph√≤ng ban</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Ph√≤ng ban qu·∫£n l√Ω</h3>
    <ul>
      <li>Ph√≤ng K·ªπ thu·∫≠t</li>
      <li>Ph√≤ng ƒêi·ªán t·ª≠</li>
      <li>Ph√≤ng V·∫≠t l√Ω</li>
      <li>Ph√≤ng Tin h·ªçc</li>
      <li>Ph√≤ng H√†nh ch√≠nh</li>
      <li>Ph√≤ng ƒê√†o t·∫°o</li>
      <li>Kh√°c (cho ph√©p nh·∫≠p th·ªß c√¥ng)</li>
    </ul>

    <button class="update-btn" onclick="updateDepartments()">C·∫≠p nh·∫≠t ph√≤ng ban</button>
    <button class="finish-btn" onclick="saveDepartments()">Ho√†n t·∫•t c·∫≠p nh·∫≠t</button>
    <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Quay l·∫°i</button>
  </div>

  <script>
    const API_URL = "http://localhost:2704/api/devices";
    const SAVE_URL = "http://localhost:2704/api/classified-devices";
    let devices = [];

    async function loadDevices() {
      try {
        const res = await fetch(API_URL);
        const json = await res.json();
        if (!json.success) throw new Error();
        devices = json.data;
        renderTable();
      } catch (err) {
        alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch thi·∫øt b·ªã.");
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#deviceTable tbody");
      tbody.innerHTML = "";

      devices.forEach(device => {
        const currentDept = device.department || "";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${device.id}</td>
          <td>${device.name}</td>
          <td>${device.type}</td>
          <td>${device.status}</td>
          <td>${device.date}</td>
          <td>
            <select data-id="${device.id}" onchange="handleDepartmentChange(event)">
              <option value="">-- Ch·ªçn ph√≤ng ban --</option>
              <option value="K·ªπ thu·∫≠t" ${currentDept === "K·ªπ thu·∫≠t" ? "selected" : ""}>Ph√≤ng K·ªπ thu·∫≠t</option>
              <option value="ƒêi·ªán t·ª≠" ${currentDept === "ƒêi·ªán t·ª≠" ? "selected" : ""}>Ph√≤ng ƒêi·ªán t·ª≠</option>
              <option value="V·∫≠t l√Ω" ${currentDept === "V·∫≠t l√Ω" ? "selected" : ""}>Ph√≤ng V·∫≠t l√Ω</option>
              <option value="Tin h·ªçc" ${currentDept === "Tin h·ªçc" ? "selected" : ""}>Ph√≤ng Tin h·ªçc</option>
              <option value="H√†nh ch√≠nh" ${currentDept === "H√†nh ch√≠nh" ? "selected" : ""}>Ph√≤ng H√†nh ch√≠nh</option>
              <option value="ƒê√†o t·∫°o" ${currentDept === "ƒê√†o t·∫°o" ? "selected" : ""}>Ph√≤ng ƒê√†o t·∫°o</option>
              <option value="Kh√°c" ${!["K·ªπ thu·∫≠t","ƒêi·ªán t·ª≠","V·∫≠t l√Ω","Tin h·ªçc","H√†nh ch√≠nh","ƒê√†o t·∫°o"].includes(currentDept) && currentDept ? "selected" : ""}>Kh√°c</option>
            </select>
            <input type="text" placeholder="Nh·∫≠p t√™n ph√≤ng ban..." 
              style="display: ${!["K·ªπ thu·∫≠t","ƒêi·ªán t·ª≠","V·∫≠t l√Ω","Tin h·ªçc","H√†nh ch√≠nh","ƒê√†o t·∫°o"].includes(currentDept) && currentDept ? "block" : "none"}; margin-top:5px;" 
              data-custom="true" data-id="${device.id}" 
              value="${!["K·ªπ thu·∫≠t","ƒêi·ªán t·ª≠","V·∫≠t l√Ω","Tin h·ªçc","H√†nh ch√≠nh","ƒê√†o t·∫°o"].includes(currentDept) ? currentDept : ""}" />
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function handleDepartmentChange(e) {
      const select = e.target;
      const id = select.dataset.id;
      const customInput = document.querySelector(`input[data-custom="true"][data-id="${id}"]`);
      if (select.value === "Kh√°c") {
        customInput.style.display = "block";
      } else {
        customInput.style.display = "none";
        customInput.value = "";
      }
    }

    function updateDepartments() {
      const selects = document.querySelectorAll("select[data-id]");
      selects.forEach(select => {
        const id = select.dataset.id;
        const value = select.value;
        const customInput = document.querySelector(`input[data-custom="true"][data-id="${id}"]`);
        const department = value === "Kh√°c" ? customInput.value.trim() : value;
        const device = devices.find(d => String(d.id) === String(id));
        if (device) device.department = department;
      });
      alert("‚úîÔ∏è ƒê√£ c·∫≠p nh·∫≠t ph√≤ng ban t·∫°m th·ªùi.");
      renderTable(); // gi·ªØ l·∫°i tr·∫°ng th√°i khi render l·∫°i
    }

    async function saveDepartments() {
      try {
        updateDepartments(); // c·∫≠p nh·∫≠t tr∆∞·ªõc khi l∆∞u
        const res = await fetch(SAVE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ devices })
        });
        const json = await res.json();
        if (json.success) {
          alert("‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu ph√≤ng ban th√†nh c√¥ng!");
        } else {
          alert("‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu: " + json.message);
        }
      } catch (err) {
        console.error("Save error:", err);
        alert("üö´ Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server.");
      }
    }

    loadDevices();
  </script>
</body>
</html>
